<h1 id="virgilauthservice">VirgilAuthService</h1>
<ul>
<li>[Virgil authentification service] (#virgil-authentification-service)<ul>
<li><a href="#post-get-message">POST /get-message</a></li>
<li>[POST /verify-message] (#post-verify-message)</li>
<li>[GET /verify-token/{token}] (#get-verify-tokentoken)</li>
<li>[GET /token/{token}/info] (#get-tokentokeninfo)</li>
</ul>
</li>
<li>[Appendix A. Response codes] (#appendix-a-response-codes)</li>
</ul>
<h1 id="virgil-authentification-service">Virgil authentification service</h1>
<p>service is designed to get ability authenticate users who use Virgil keys. The working principle presented below on the scheme
<img src="https://github.com/ddain/VirgilAuthService/blob/master/doc/scheme-1.jpg" alt="alt tag"></p>
<h2 id="post-get-message">POST /get-message</h2>
<p>Retrieve encrypted message</p>
<p>Request info</p>
<pre><code>HTTP Request <span class="hljs-function"><span class="hljs-keyword">method</span>    <span class="hljs-title">POST</span>
<span class="hljs-title">Request</span> <span class="hljs-title">URL</span>            <span class="hljs-title">https</span>:</span><span class="hljs-comment">//auth.virgilsecurity.com/get-message</span>
</code></pre><p>Request body</p>
<pre><code class="lang-json">{
    "<span class="hljs-attribute">id</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">email</span>": <span class="hljs-value"><span class="hljs-string">"test@example.com"</span>
    </span>}</span>,
    "<span class="hljs-attribute">app_id</span>": <span class="hljs-value"><span class="hljs-string">"application_id"</span>
</span>}
</code></pre>
<p>Where <code>id</code> is object where key is user data type (eg. email) and value is user data value.
<code>app_id</code> is application id (eg. chrome-ext, ios-app, virgil-sync etc.)</p>
<p>Response body</p>
<pre><code class="lang-json">{
    "<span class="hljs-attribute">id</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">email</span>": <span class="hljs-value"><span class="hljs-string">"test@example.com"</span>
    </span>}</span>,
    "<span class="hljs-attribute">app_id</span>": <span class="hljs-value"><span class="hljs-string">"application_id"</span></span>,
    "<span class="hljs-attribute">encrypted_data</span>": <span class="hljs-value"><span class="hljs-string">"BASE64-ENCODED-DATA"</span></span>,
    "<span class="hljs-attribute">embed_content_info</span>": <span class="hljs-value"><span class="hljs-literal">true</span></span>,
    "<span class="hljs-attribute">recipient_public_key_id</span>": <span class="hljs-value"><span class="hljs-string">"cfc71f7c-560d-4a62-8d65-16b87419a554"</span>
    <span class="hljs-string">"sign"</span>: {
        "<span class="hljs-attribute">hash_name</span>": <span class="hljs-value"><span class="hljs-string">"sha512"</span></span>,
        "<span class="hljs-attribute">signed_digest</span>": <span class="hljs-value"><span class="hljs-string">"BASE64_ENCODED_DATA"</span></span>,
        "<span class="hljs-attribute">signer_public_key_id</span>": <span class="hljs-value"><span class="hljs-string">"cd171f7c-560d-4a62-8d65-16b87419a58c"</span>
    </span>}
</span>}
</code></pre>
<p>Where <code>id</code> and <code>app_id</code> are values which presented at the request.
<code>encrypted_data</code> is encrypted and then base64 encoded data with embedded content info. Client should base64 decode and decrypt data using flag <code>embed_content_info = true;</code>. 
Sign object contains <code>hash_name</code>, <code>signed_digest</code> and <code>signer_public_key_id</code>, which requires to create sign object.</p>
<p>Request sample</p>
<pre><code>curl -v -X POST https://auth.virgilsecurity.com/get-<span class="hljs-keyword">message</span> --data '{<span class="hljs-string">"id"</span>:{<span class="hljs-string">"email"</span>:<span class="hljs-string">"test@example.com"</span>},<span class="hljs-string">"app_id"</span>: <span class="hljs-string">"application_id"</span>}'
</code></pre><p>When client retrievs response from the server, client has to verify sign. See example below:</p>
<pre><code class="lang-php"><span class="hljs-variable">$signer</span> = new \<span class="hljs-constant">VirgilSigner(</span>);

<span class="hljs-variable">$virgilSign</span> = new \<span class="hljs-constant">VirgilSign(</span>);
<span class="hljs-variable">$virgilSign</span>-&gt;fromJson((<span class="hljs-variable">$sign</span>)); <span class="hljs-regexp">//</span> <span class="hljs-variable">$sign</span> is json object from response

<span class="hljs-variable">$signer</span>-&gt;verify(base64_decode(<span class="hljs-variable">$encrypted_data</span>), <span class="hljs-variable">$virgilSign</span>, <span class="hljs-variable">$signerPublicKey</span>); <span class="hljs-regexp">//</span> <span class="hljs-variable">$encrypted_data</span> - encrypted_data from response. <span class="hljs-variable">$signerPublicKey</span> - signer public key (<span class="hljs-keyword">in</span> this <span class="hljs-keyword">case</span> this is a <span class="hljs-constant">VirgilAuthService </span>public key).
</code></pre>
<p>After verifying sign client has to decrypt message:</p>
<pre><code class="lang-php"><span class="hljs-variable">$cipher</span> <span class="hljs-subst">=</span> <span class="hljs-literal">new</span> <span class="hljs-subst">\</span>VirgilCipher();

<span class="hljs-variable">$cipher</span><span class="hljs-subst">-&gt;</span>decryptWithKey(base64_decode(<span class="hljs-variable">$encrypted_data</span>), <span class="hljs-variable">$publicKeyId</span>, <span class="hljs-variable">$privateKey</span>, <span class="hljs-variable">$password</span>); <span class="hljs-comment">// encrypted_data - from response, publicKeyId - recipient public key id, privateKey - recipient private key</span>
</code></pre>
<p>After that client has to encrypt message, sign and send to [/verify-message] (#post-verify-message). To encrypt data client has to use Virgil Auth Service public key. Example how to encrypt data see below:</p>
<pre><code class="lang-php"><span class="hljs-variable">$cipher</span> <span class="hljs-subst">=</span> <span class="hljs-literal">new</span> <span class="hljs-subst">\</span>VirgilCipher();

<span class="hljs-variable">$cipher</span><span class="hljs-subst">-&gt;</span>addKeyRecipient(<span class="hljs-variable">$publicKeyId</span>, <span class="hljs-variable">$publicKey</span>); <span class="hljs-comment">// publicKeyId - virgil auth service public key id, publicKey - virgil auth public key</span>

<span class="hljs-variable">$encryptedData</span> <span class="hljs-subst">=</span> <span class="hljs-variable">$cipher</span><span class="hljs-subst">-&gt;</span>encrypt(<span class="hljs-variable">$data</span>, <span class="hljs-literal">true</span>);

<span class="hljs-variable">$dataToSend</span> <span class="hljs-subst">=</span> base64_encode(<span class="hljs-variable">$encryptedData</span>); <span class="hljs-comment">// data which should be send to the server</span>
</code></pre>
<h2 id="post-verify-message">POST /verify-message</h2>
<p>Verify decripted message</p>
<p>Request info</p>
<pre><code>HTTP Request <span class="hljs-function"><span class="hljs-keyword">method</span>    <span class="hljs-title">POST</span>
<span class="hljs-title">Request</span> <span class="hljs-title">URL</span>            <span class="hljs-title">https</span>:</span><span class="hljs-comment">//auth.virgilsecurity.com/verify-message</span>
</code></pre><p>Request body</p>
<pre><code class="lang-json">{
    "<span class="hljs-attribute">id</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">email</span>": <span class="hljs-value"><span class="hljs-string">"test@example.com"</span>
    </span>}</span>,
    "<span class="hljs-attribute">app_id</span>": <span class="hljs-value"><span class="hljs-string">"application_id"</span></span>,
    "<span class="hljs-attribute">encrypted_data</span>": <span class="hljs-value"><span class="hljs-string">"BASE64-ENCODED-DATA"</span></span>,
    "<span class="hljs-attribute">sign</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">hash_name</span>": <span class="hljs-value"><span class="hljs-string">"sha512"</span></span>,
        "<span class="hljs-attribute">signed_digest</span>": <span class="hljs-value"><span class="hljs-string">"BASE64_ENCODED_DATA"</span></span>,
        "<span class="hljs-attribute">signer_public_key_id</span>": <span class="hljs-value"><span class="hljs-string">"cd171f7c-560d-4a62-8d65-16b87419a58c"</span>
    </span>}
</span>}
</code></pre>
<p>Where <code>id</code> and <code>app_id</code> values which presented in first request. <code>encrypted_data</code> data which was retrieved form server decrypted, encrypted using Virgil Auth service public key and base64 encoded. 
<code>sign</code> is object which was retrieved by signing encrypted data before base64 encoding. See example below:</p>
<pre><code class="lang-php"><span class="hljs-variable">$signer</span> <span class="hljs-subst">=</span> <span class="hljs-literal">new</span> <span class="hljs-subst">\</span>VirgilSigner();

<span class="hljs-variable">$sign</span> <span class="hljs-subst">=</span> <span class="hljs-variable">$signer</span><span class="hljs-subst">-&gt;</span>sign(<span class="hljs-variable">$data</span>, <span class="hljs-variable">$signerPublicKeyId</span>, <span class="hljs-variable">$privateKey</span>, <span class="hljs-variable">$password</span>); <span class="hljs-built_in">data</span> <span class="hljs-subst">-</span> encrypted <span class="hljs-built_in">data</span> before base <span class="hljs-number">64</span> encoding<span class="hljs-built_in">. </span>signer <span class="hljs-keyword">public</span> key id, <span class="hljs-keyword">private</span> key, password <span class="hljs-subst">-</span> user <span class="hljs-keyword">public</span> key id, <span class="hljs-keyword">private</span> key <span class="hljs-literal">and</span> password<span class="hljs-built_in">.
</span><span class="hljs-variable">$sign</span><span class="hljs-subst">-&gt;</span>toJSON();
</code></pre>
<p>Response body</p>
<pre><code class="lang-json">{
    "<span class="hljs-attribute">id</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">email</span>": <span class="hljs-value"><span class="hljs-string">"test@example.com"</span>
    </span>}</span>,
    "<span class="hljs-attribute">app_id</span>": <span class="hljs-value"><span class="hljs-string">"application_id"</span></span>,
    "<span class="hljs-attribute">token</span>": <span class="hljs-value"><span class="hljs-string">"token"</span></span>,
    "<span class="hljs-attribute">sign</span>": <span class="hljs-value">{
        "<span class="hljs-attribute">hash_name</span>": <span class="hljs-value"><span class="hljs-string">"sha512"</span></span>,
        "<span class="hljs-attribute">signed_digest</span>": <span class="hljs-value"><span class="hljs-string">"BASE64_ENCODED_DATA"</span></span>,
        "<span class="hljs-attribute">signer_public_key_id</span>": <span class="hljs-value"><span class="hljs-string">"cd171f7c-560d-4a62-8d65-16b87419a58c"</span>
    </span>}
</span>}
</code></pre>
<p>Request sample</p>
<pre><code>curl -v -X POST https://auth.virgilsecurity.com/verify-<span class="hljs-keyword">message</span> --data '{<span class="hljs-string">"id"</span>:{<span class="hljs-string">"email"</span>:<span class="hljs-string">"test@example.com"</span>},<span class="hljs-string">"app_id"</span>:<span class="hljs-string">"application_id"</span>,<span class="hljs-string">"encrypted_data:"</span>BASE64_ENCODED_DATA<span class="hljs-string">","</span>encryption_key<span class="hljs-string">":"</span>BASE64_ENCODED_DATA<span class="hljs-string">","</span>sign<span class="hljs-string">":{"</span>hash_name<span class="hljs-string">":"</span>sha512<span class="hljs-string">","</span>signed_digest<span class="hljs-string">":"</span>BASE64_ENCODED_DATA<span class="hljs-string">","</span>signer_public_key_id<span class="hljs-string">":"</span>cd171f7c-<span class="hljs-number">560</span>d-<span class="hljs-number">4</span>a62-<span class="hljs-number">8</span>d65-<span class="hljs-number">16</span>b87419a58c<span class="hljs-string">"}}'</span>
</code></pre><h1 id="get-verify-token-token-">GET /verify-token/{token}</h1>
<p>Verify if token is active</p>
<p>Request info</p>
<pre><code>HTTP Request <span class="hljs-function"><span class="hljs-keyword">method</span>    <span class="hljs-title">POST</span>
<span class="hljs-title">Request</span> <span class="hljs-title">URL</span>            <span class="hljs-title">https</span>:</span><span class="hljs-comment">//auth.virgilsecurity.com/verify-token/{token}</span>
</code></pre><p>Request body</p>
<pre><code><span class="hljs-deletion">-</span>
</code></pre><p>Response body</p>
<pre><code class="lang-json">{
    "<span class="hljs-attribute">is_active</span>": <span class="hljs-value"><span class="hljs-literal">true</span>
</span>}
</code></pre>
<p>Request sample</p>
<pre><code>curl -v -X GET <span class="hljs-keyword">https</span>://auth.virgilsecurity.com/verify-<span class="hljs-keyword">token</span>/{<span class="hljs-keyword">token</span>}
</code></pre><h2 id="get-token-token-info">GET /token/{token}/info</h2>
<p>Retrieve account info by token</p>
<p>Request info</p>
<pre><code>HTTP Request <span class="hljs-function"><span class="hljs-keyword">method</span>    <span class="hljs-title">POST</span>
<span class="hljs-title">Request</span> <span class="hljs-title">URL</span>            <span class="hljs-title">https</span>:</span><span class="hljs-comment">//auth.virgilsecurity.com/token/{token}/info</span>
</code></pre><p>Request body</p>
<pre><code><span class="hljs-deletion">-</span>
</code></pre><p>Response body</p>
<pre><code class="lang-json">{
    "<span class="hljs-attribute">first_name</span>": <span class="hljs-value"><span class="hljs-string">"First name"</span></span>,
    "<span class="hljs-attribute">last_name</span>": <span class="hljs-value"><span class="hljs-string">"Last name"</span>
</span>}
</code></pre>
<p>Request sample</p>
<pre><code>curl -v -X GET <span class="hljs-keyword">https</span>://auth.virgilsecurity.com/<span class="hljs-keyword">token</span>/{<span class="hljs-keyword">token</span>}/info
</code></pre><h1 id="appendix-a-response-codes">Appendix A. Response codes</h1>
<p>Application uses standard HTTP response codes:</p>
<pre><code><span class="hljs-number">200</span> - Success
<span class="hljs-number">400</span> - <span class="hljs-built_in">Request</span> <span class="hljs-keyword">error</span>
<span class="hljs-number">404</span> - Entity <span class="hljs-keyword">not</span> found
<span class="hljs-number">500</span> - <span class="hljs-built_in">Server</span> <span class="hljs-keyword">error</span>
</code></pre><p>Addtitional information about the error is returned as JSON-object like:</p>
<pre><code class="lang-json"><span class="hljs-collection">{
    <span class="hljs-string">"code"</span>: <span class="hljs-collection">{error-code}</span>
}</span>
</code></pre>
<p><strong><code>HTTP 500. Server error</code></strong> status is returned on internal application errors</p>
<p><strong><code>HTTP 400. Request error</code></strong> status is returned on request data validation errors</p>
<pre><code><span class="hljs-number">441</span> <span class="hljs-subst">-</span> Unable <span class="hljs-keyword">to</span> find <span class="hljs-keyword">public</span> key <span class="hljs-keyword">by</span> user <span class="hljs-built_in">data</span>
<span class="hljs-number">442</span> <span class="hljs-subst">-</span> Message verification failed
<span class="hljs-number">443</span> <span class="hljs-subst">-</span> Invalid user <span class="hljs-built_in">data</span> value <span class="hljs-literal">or</span> <span class="hljs-keyword">type</span>
<span class="hljs-number">444</span> <span class="hljs-subst">-</span> Invalid signature 
<span class="hljs-number">445</span> <span class="hljs-subst">-</span> Invalid token
<span class="hljs-number">446</span> <span class="hljs-subst">-</span> User <span class="hljs-built_in">data</span> <span class="hljs-literal">not</span> found <span class="hljs-keyword">on</span> PKI
<span class="hljs-number">447</span> <span class="hljs-subst">-</span> Unable <span class="hljs-keyword">to</span> get <span class="hljs-keyword">public</span> key from PKI
</code></pre>